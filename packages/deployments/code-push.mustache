#!/bin/bash
# Simplify Automatic Deployment Script
# Project: {{projectNamePosix}}
# Deployment: {{deploymentNamePosix}}
# Region: {{deploymentRegionOrigin}}
# Profile: {{deploymentProfileOrigin}}
# Version: {{projectVersion}}
INITIAL_DIR=$PWD
export $(egrep -v '^#' .env | xargs)

node code-init.js --input {{deploymentNamePosix}}.json

{{#services}}
export DEPLOYMENT_STAGE=${ENV_{{serviceName}}_DEPLOYMENT_STAGE}
export ENFORCEMENT_PACKAGE=${ENV_{{serviceName}}_ENFORCEMENT_PACKAGE}
cd ${INITIAL_DIR}/{{projectName}}/{{serviceName}} && npm install && npm run build && npm run deploy && cd -
if [ $? -ne 0 ]; then
    echo "Publishing {{serviceName}} (latest) version has failed!"
    exit 255
fi
{{/services}}